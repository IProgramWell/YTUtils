Todo:
 * Convert this thing into an extention. It's already too big to reasonably be a userscript.